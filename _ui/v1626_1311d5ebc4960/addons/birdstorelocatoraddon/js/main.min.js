'use strict';

var AuchanDirectManager = function () {

    lateMixin(AuchanDirectManager.prototype, woosmap.utils.MVCObject.prototype);

    this.zipCode = null;
    this.displayDirectPanel = null;
    this.auchanDirectZipcodes = [
        '01120', '01600', '01700', '13001', '13002', '13003', '13004', '13005', '13006', '13007', '13008', '13009',
        '13010', '13011', '13012', '13013', '13014', '13015', '13016', '13080', '13090', '13100', '13105', '13109',
        '13110', '13111', '13112', '13113', '13114', '13116', '13117', '13118', '13119', '13120', '13121', '13122',
        '13124', '13126', '13127', '13130', '13140', '13170', '13180', '13190', '13220', '13240', '13250', '13260',
        '13270', '13290', '13300', '13320', '13330', '13340', '13360', '13380', '13390', '13400', '13410', '13420',
        '13430', '13450', '13470', '13480', '13490', '13500', '13510', '13530', '13540', '13580', '13590', '13600',
        '13610', '13620', '13650', '13680', '13700', '13710', '13720', '13730', '13740', '13760', '13770', '13780',
        '13790', '13800', '13820', '13821', '13830', '13840', '13850', '13880', '13920', '13950', '13960', '13980',
        '38070', '38080', '38090', '38300', '38540', '38670', '38790', '42000', '42100', '42230', '42270', '42350',
        '42390', '42530', '42650', '59000', '59100', '59110', '59112', '59113', '59114', '59115', '59116', '59117',
        '59118', '59120', '59126', '59128', '59130', '59133', '59134', '59136', '59139', '59147', '59148', '59150',
        '59152', '59155', '59160', '59162', '59166', '59167', '59170', '59174', '59175', '59178', '59181', '59184',
        '59185', '59190', '59192', '59193', '59194', '59200', '59211', '59221', '59223', '59226', '59230', '59232',
        '59235', '59236', '59237', '59239', '59242', '59246', '59249', '59250', '59251', '59253', '59260', '59261',
        '59262', '59263', '59270', '59272', '59273', '59274', '59280', '59283', '59290', '59299', '59300', '59310',
        '59320', '59350', '59370', '59390', '59410', '59420', '59480', '59491', '59493', '59494', '59496', '59500',
        '59510', '59520', '59551', '59560', '59590', '59650', '59700', '59710', '59770', '59777', '59780', '59790',
        '59800', '59810', '59830', '59840', '59850', '59860', '59870', '59880', '59890', '59910', '59930', '59940',
        '59950', '59960', '62000', '62110', '62113', '62118', '62119', '62136', '62138', '62141', '62149', '62210',
        '62217', '62220', '62221', '62223', '62300', '62320', '62400', '62410', '62430', '62490', '62580', '62590',
        '62640', '62660', '62680', '62710', '62750', '62764', '62820', '62840', '62950', '62970', '62980', '69001',
        '69002', '69003', '69004', '69005', '69006', '69007', '69008', '69009', '69100', '69110', '69120', '69126',
        '69130', '69140', '69150', '69160', '69190', '69200', '69210', '69230', '69250', '69260', '69270', '69280',
        '69290', '69300', '69310', '69320', '69330', '69340', '69350', '69360', '69370', '69380', '69390', '69410',
        '69450', '69480', '69500', '69520', '69530', '69540', '69570', '69580', '69600', '69630', '69660', '69670',
        '69680', '69700', '69720', '69730', '69740', '69760', '69780', '69800', '69890', '69960', '69970', '75001',
        '75002', '75003', '75004', '75005', '75006', '75007', '75008', '75009', '75010', '75011', '75012', '75013',
        '75014', '75015', '75016', '75017', '75018', '75019', '75020', '75116', '77000', '77090', '77127', '77135',
        '77144', '77150', '77164', '77166', '77170', '77173', '77176', '77177', '77183', '77184', '77185', '77186',
        '77190', '77200', '77220', '77240', '77310', '77330', '77340', '77350', '77360', '77380', '77400', '77420',
        '77450', '77500', '77550', '77580', '77600', '77630', '77680', '77700', '77860', '77930', '77950', '78000',
        '78100', '78110', '78112', '78114', '78117', '78120', '78121', '78124', '78125', '78130', '78140', '78150',
        '78160', '78170', '78180', '78190', '78210', '78220', '78230', '78240', '78250', '78260', '78280', '78290',
        '78300', '78310', '78320', '78330', '78340', '78350', '78360', '78370', '78380', '78390', '78400', '78420',
        '78430', '78450', '78460', '78470', '78480', '78500', '78510', '78530', '78540', '78560', '78570', '78580',
        '78590', '78600', '78610', '78620', '78630', '78640', '78650', '78670', '78690', '78700', '78720', '78730',
        '78740', '78750', '78760', '78770', '78780', '78800', '78810', '78830', '78850', '78860', '78870', '78920',
        '78955', '78960', '78990', '83110', '83140', '83150', '83270', '91000', '91070', '91080', '91090', '91100',
        '91120', '91130', '91140', '91150', '91160', '91170', '91180', '91190', '91200', '91210', '91220', '91230',
        '91240', '91250', '91260', '91270', '91280', '91290', '91300', '91310', '91320', '91330', '91340', '91360',
        '91370', '91380', '91390', '91400', '91410', '91420', '91430', '91440', '91450', '91460', '91470', '91480',
        '91490', '91510', '91520', '91530', '91540', '91550', '91560', '91570', '91580', '91590', '91600', '91610',
        '91620', '91630', '91640', '91650', '91680', '91700', '91710', '91720', '91730', '91750', '91760', '91770',
        '91790', '91800', '91810', '91820', '91830', '91840', '91850', '91860', '91870', '91880', '91940', '92000',
        '92100', '92110', '92120', '92130', '92140', '92150', '92160', '92170', '92190', '92200', '92210', '92220',
        '92230', '92240', '92250', '92260', '92270', '92290', '92300', '92310', '92320', '92330', '92340', '92350',
        '92360', '92370', '92380', '92390', '92400', '92410', '92420', '92430', '92500', '92600', '92700', '92800',
        '93100', '93110', '93130', '93140', '93160', '93170', '93190', '93200', '93210', '93220', '93230', '93250',
        '93260', '93300', '93310', '93320', '93330', '93340', '93360', '93400', '93450', '93460', '93500', '93800',
        '94000', '94100', '94110', '94120', '94130', '94140', '94150', '94160', '94170', '94190', '94200', '94210',
        '94220', '94230', '94240', '94250', '94260', '94270', '94290', '94300', '94310', '94320', '94340', '94350',
        '94360', '94370', '94380', '94400', '94410', '94420', '94430', '94440', '94450', '94460', '94470', '94480',
        '94490', '94500', '94510', '94520', '94550', '94600', '94700', '94800', '94880', '95000', '95100', '95110',
        '95120', '95130', '95140', '95150', '95160', '95170', '95180', '95190', '95210', '95220', '95230', '95240',
        '95250', '95270', '95280', '95290', '95300', '95310', '95320', '95330', '95350', '95360', '95370', '95390',
        '95400', '95410', '95430', '95440', '95450', '95460', '95480', '95490', '95500', '95520', '95530', '95540',
        '95550', '95560', '95570', '95580', '95590', '95600', '95610', '95620', '95630', '95650', '95670', '95680',
        '95720', '95740', '95760', '95800', '95810', '95840', '95870', '95880', '99226', '99999'
    ];
};

AuchanDirectManager.prototype.shouldDisplayDirectPanel = function (zipcode) {
    return this.auchanDirectZipcodes.indexOf(zipcode) >= 0;
};

AuchanDirectManager.prototype.zipcode_changed = function () {
    this.set('displayDirectPanel', this.shouldDisplayDirectPanel(this.get('zipcode').value));
};

// jshint loopfunc: true
function lateMixin(sink, source) {
    for (var property in source) {
        (function (property) {
            sink[property] = function () {
                return source[property].apply(this, arguments);
            };
        }(property));
    }
}
// jshint loopfunc: false

/* jshint ignore:start */
var auchanTemplates = {};
auchanTemplates['auchanDirectTemplate'] = "<div class=\"auchan-woosmap-direct-container\">\n    <div class=\"auchan-woosmap-direct-text\">Et également : vos courses livrées à domicile</div>\n    <div class=\"auchan-woosmap-direct-logo\"></div>\n        <a href=\"http://www.auchandirect.fr/Accueil\" class=\"auchan-woosmap-direct-button auchan-woosmap-input-button\">Voir le site Auchan Direct</a>\n</div>";
auchanTemplates['defaultCellTemplate'] = "<div class=\"auchan-woosmap-cell-container\">\n    <span class=\"auchan-woosmap-cell-title\">{{address.departementCode}} - {{name}}</span>\n    <span>{{address.zipcode}} {{address.city}}</span>\n</div>";
auchanTemplates['defaultNearestStore'] = "<a id=\"auchan-woosmap-nearest-store-geolocation-button\" class=\"auchan-woosmap-nearest-store-geolocation-button\">\n    Me localiser\n</a>\n<div class=\"auchan-woosmap-nearest-store-explanation\">\n    Pour obtenir le magasin le plus proche de votre position, veuillez vous localiser.\n</div>\n";
auchanTemplates['directionsSummaryTemplate'] = "<div class=\"auchan-woosmap-route-container\" data-renderer-index=\"{{ rendererIndex }}\">\n    <div class=\"auchan-woosmap-routes-sub-container auchan-woosmap-route-travel-mode-icon auchan-woosmap-font\">*</div>\n    <div class=\"auchan-woosmap-routes-sub-container auchan-woosmap-text-container\">\n        <div>\n            <span class=\"auchan-woosmap-route-summary\">{{ summary }}</span>\n            <span class=\"auchan-woosmap-route-time-with-traffic\">{{ durationInTrafficShort }}</span>\n        </div>\n        <div>\n            <span class=\"auchan-woosmap-route-time-without-traffic\">{{ durationShort }} sans circulation</span>\n            <span class=\"auchan-woosmap-route-distance\">{{ distance }}</span>\n        </div>\n    </div>\n    <div class=\"auchan-woosmap-routes-sub-container icon-array-container auchan-woosmap-font auchan-desktop-button\">$</div>\n    <div class=\"auchan-woosmap-routes-sub-container icon-array-container auchan-woosmap-font woosmap-mobile-link-button\">$</div>\n</div>";
auchanTemplates['infoWindow'] = "<div class=\"auchan-woosmap-infobox-content\">\n    {{#onlyDrive}}\n        <span class=\"auchan-woosmap-infobox-left-caret\"></span>\n        <p class=\"auchan-woosmap-drive-logo\"></p>\n        <div class=\"auchan-woosmap-infobox-address\">\n            <p>{{#address.lines}}</p><p>{{.}}</p><p>{{/address.lines}}</p>\n            <p>{{address.zipcode}} {{address.city}}</p>\n        </div>\n        <ul>\n            {{#contact.phone}}<li><span><b>Tél.</b></span>{{contact.phone}}</li>{{/contact.phone}}\n            <li class=\"auchan-woosmap-open-directions\"><span class=\"auchan-woosmap-font\">$</span>Itinéraire</li>\n        </ul>\n\n        <a href=\"{{user_properties.drive_informations.website}}\"\n           target=\"_blank\"\n           class=\"auchan-woosmap-input-button auchan-woosmap-show-drive-store-button\">Voir le site Auchan Drive</a>\n    {{/onlyDrive}}\n    {{^onlyDrive}}\n        <span class=\"auchan-woosmap-infobox-left-caret {{#user_properties.drive_informations}}auchan-woosmap-infobox-left-caret-drive{{/user_properties.drive_informations}}\"></span>\n\n        <div class=\"auchan-woosmap-infobox-name\">{{name}}</div>\n        {{#open.open_hours}}\n        <p class=\"auchan-woosmap-openhour\">\n            <span class=\"auchan-woosmap-font auchan-woosmap-opening-puce\">N </span>\n            Ouvert aujourd'hui de <b>{{open.open_hours.0.start}}</b> à <b>{{open.open_hours.0.end}}</b></p>\n        {{/open.open_hours}}\n        {{^open.open_hours}}\n        <p class=\"auchan-woosmap-closehour\">\n            <span class=\"auchan-woosmap-font auchan-woosmap-opening-puce\">N </span>\n            Magasin fermé aujourd'hui</p>\n        {{/open.open_hours}}\n        <div class=\"auchan-woosmap-infobox-address\"><p>{{#address.lines}}<p>{{.}}</p>{{/address.lines}}</p>\n\n            <p>{{address.zipcode}} {{address.city}}</p></div>\n        <ul>\n            <li><span><b>Tél.</b></span>{{contact.phone}}</li>\n            <li class=\"auchan-woosmap-open-directions\"><span class=\"auchan-woosmap-font\">$</span>Itinéraire</li>\n        </ul>\n        <a href=\"{{#contact.website}}{{contact.website}}{{/contact.website}}{{^contact.website}}#{{/contact.website}}\"\n           target=\"_self\"\n           class=\"auchan-woosmap-input-button auchan-woosmap-show-store-button\">Voir ce magasin</a>\n        {{#user_properties.drive_informations}}\n\n            <p class=\"auchan-woosmap-infobox-drive-separator\"></p>\n            <p><b>Et également : </b> vos courses dans votre coffre.</p>\n            <p class=\"auchan-woosmap-drive-logo\"></p>\n            <div class=\"auchan-woosmap-infobox-address\">\n                <p>{{#user_properties.drive_informations.address.lines}}</p>\n                <p>{{.}}</p>\n                <p>{{/user_properties.drive_informations.address.lines}}</p>\n                <p>{{user_properties.drive_informations.address.zipcode}} {{user_properties.drive_informations.address.city}}</p>\n            </div>\n            <ul>\n                <li><span><b>Tél.</b></span>{{user_properties.drive_informations.phone}}</li>\n                <li class=\"auchan-woosmap-open-directions\"><span class=\"auchan-woosmap-font\">$</span>Itinéraire</li>\n            </ul>\n            <a href=\"{{user_properties.drive_informations.website}}\"\n               target=\"_blank\"\n                class=\"auchan-woosmap-input-button auchan-woosmap-show-drive-store-button\">Voir le site Auchan Drive</a>\n\n        {{/user_properties.drive_informations}}\n    {{/onlyDrive}}\n</div>\n\n";
auchanTemplates['mailViewTemplate'] = "<div class=\"auchan-woosmap-send-route-container\">\n    <div class=\"auchan-woosmap-send-route-header\">\n        <span class=\"auchan-woosmap-font auchan-woosmap-send-route-phone-icon\">o</span>\n        <span class=\"auchan-woosmap-send-by-mail-header-text\">Envoyer cet itinéraire sur mon mobile</span>\n        <span class=\"auchan-woosmap-send-route-display-form\">+</span>\n    </div>\n    <div class=\"auchan-woosmap-send-route-form\">\n        <div class=\"auchan-woosmap-input-container auchan-woosmap-send-route-mail-input\">\n            <input type=\"email\"\n                   class=\"auchan-woosmap-text-input woosmap-mail-input\"\n                   placeholder=\"email\">\n        </div>\n        <div class=\"auchan-woosmap-input-button auchan-woosmap-send-route-button woosmap-send-button\">OK</div>\n        <div class=\"auchan-woosmap-mail-status\"></div>\n    </div>\n</div>";
auchanTemplates['nearestStore'] = "<div class=\"auchan-woosmap-nearest-col-1\">\n    <span class=\"auchan-woosmap-nearest-store-logo\"></span>\n\n</div>\n<div class=\"auchan-woosmap-nearest-col-2\">\n    <span class=\"auchan-woosmap-nearest-store-name\">{{name}}</span>\n    <br/>\n    {{#address}}\n        {{#lines}}{{.}}<br/>{{/lines}}\n        {{zipcode}}\n        {{city}}\n    {{/address}}\n</div>\n\n{{#contact}}\n<a href=\"{{#website}}{{website}}{{/website}}{{^website}}#{{/website}}\" class=\"auchan-woosmap-link-button\">Choisir ce magasin</a>\n{{/contact}}\n";
auchanTemplates['originDestinationInputTemplate'] = "<div class=\"auchan-woosmap-directions-searchbox-container\">\n    <div class=\"auchan-woosmap-directions-searchbox-elem\">\n        <div class=\"auchan-woosmap-directions-bgimage\"></div>\n    </div>\n    <div class=\"auchan-woosmap-directions-searchbox-elem auchan-woosmap-directions-searchbox-form\">\n        <div class=\"auchan-woosmap-input-container auchan-woosmap-searchstore-od\">\n            <input type=\"text\" class=\"woosmap-origin auchan-woosmap-text-input\"\n                   placeholder=\"Choisissez un point de départ\">\n\n            <div class=\"auchan-woosmap-origin-input-cross auchan-woosmap-geolocation-button\"></div>\n        </div>\n        <div class=\"auchan-woosmap-input-container auchan-woosmap-searchstore-od auchan-woosmap-searchstore-destination\">\n            <input type=\"text\" class=\"woosmap-destination auchan-woosmap-text-input\">\n        </div>\n    </div>\n    <div class=\"auchan-woosmap-directions-searchbox-elem auchan-woosmap-directions-searchbox-toggle auchan-woosmap-font woosmap-toggle-origin-destination\">\n        _\n    </div>\n    <button class=\"auchan-woosmap-directions-searchbox-submit auchan-woosmap-input-button woosmap-direction-submit\">\n        Itinéraire\n    </button>\n</div>";
auchanTemplates['placesPredictionTemplate'] = "{{#predictions}}\r\n<div class=\"pac-item\" data-reference=\"{{reference}}\">\r\n    <span class=\"pac-icon pac-icon-marker\"></span>\r\n    <span class=\"pac-item-query\">{{description}}</span>\r\n</div>\r\n{{/predictions}}";
auchanTemplates['routesStepsTitleTemplate'] = "<div class=\"auchan-woosmap-routes-steps-title\">\n    Détail de l'itinéraire\n</div>";
auchanTemplates['searchCellTemplate'] = "<div class=\"auchan-woosmap-cell-container\">\n    <div class=\"auchan-woosmap-cell-sub-container text-container\">\n        <span class=\"auchan-woosmap-cell-title\">{{indexNumber}} - {{name}}</span>\n    {{#onlyDrive}}\n        <span class=\"auchan-woosmap-cell-stores-closing auchan-woosmap-closehour\">\n            <span class=\"auchan-woosmap-font auchan-woosmap-opening-puce\"></span>\n            <span class=\"auchan-woosmap-open-text\"></span>\n        </span>\n        {{/onlyDrive}}\n        {{^onlyDrive}}\n        {{#open.open_hours}}\n        <span class=\"auchan-woosmap-cell-stores-opening auchan-woosmap-openhour\">\n            <span class=\"auchan-woosmap-font auchan-woosmap-opening-puce\">N </span>\n            <span class=\"auchan-woosmap-open-text\">Ouvert aujourd'hui de <b>{{open.open_hours.0.start}}</b> à <b>{{open.open_hours.0.end}}</b></span>\n        </span>\n        {{/open.open_hours}}\n        {{^open.open_hours}}\n        <span class=\"auchan-woosmap-cell-stores-closing auchan-woosmap-closehour\">\n            <span class=\"auchan-woosmap-font auchan-woosmap-opening-puce\">N </span>\n            <span class=\"auchan-woosmap-open-text\">Magasin fermé aujourd'hui</span>\n        </span>\n        {{/open.open_hours}}\n        {{/onlyDrive}}\n    </div>\n    <div class=\"auchan-woosmap-cell-sub-container icon-array-container auchan-woosmap-font\n     auchan-woosmap-direction-link-icon\">$</div>\n</div>\n";
auchanTemplates['searchTitle'] = "<div class=\"auchan-woosmap-title-container\">\n    <div class=\"auchan-woosmap-search-title auchan-woosmap-tab auchan-woosmap-tab-search {{#search}} auchan-woosmap-tab-selected {{/search}}\" rel=\"#auchan-woosmap-search-container\">\n        <span class=\"auchan-woosmap-font auchan-woosmap-search-title-icon\">t</span>\n\n        <div class=\"auchan-woosmap-search-title-text auchan-woosmap-tab-title-text\">Rechercher un magasin</div>\n    </div>      \n    <div class=\"auchan-woosmap-nearest-title auchan-woosmap-tab auchan-woosmap-tab-nearest {{#nearest}} auchan-woosmap-tab-selected {{/nearest}}\" rel=\".auchan-woosmap-nearest-container\">\n        <div class=\"auchan-woosmap-nearest-title-icon\"></div>\n\n        <div class=\"auchan-woosmap-nearest-title-text auchan-woosmap-tab-title-text\">Le magasin le plus proche</div>\n    </div>\n</div>\n";
auchanTemplates['searchViewTemplate'] = "<div class=\"auchan-woosmap-search-body\">\n    <div class=\"auchan-woosmap-input-container\">\n        <input type=\"text\" class=\"auchan-woosmap-text-input woosmap-search-input\"\n               placeholder=\"Votre ville ou code postal\">\n\n        <div class=\"auchan-woosmap-search-clear woosmap-search-clear auchan-woosmap-close-icon\"></div>\n    </div>\n    {{#places}}\n    <div class=\"auchan-woosmap-search-predictions pac-container\"></div>\n    {{/places}}\n    <button class=\"auchan-woosmap-search-button auchan-woosmap-input-button woosmap-search-button\">Rechercher\n    </button>\n    <div id=\"id-auchan-woosmap-show-all-stores\">\n        <span class=\"auchan-woosmap-icon-right-arrow auchan-woosmap-font\">E</span>\n        <span class=\"auchan-woosmap-show-all-stores\">Liste des magasins</span>\n    </div>\n</div>";
auchanTemplates['travelModeTemplate'] = "<div class=\"auchan-woosmap-travel-mode-container\">\n    <span class=\"auchan-woosmap-directions-close\"></span>\n\n    <div class=\"auchan-woosmap-travel-mode-icon auchan-woosmap-font\">$</div>\n    <div class=\"auchan-woosmap-travel-mode-choice auchan-woosmap-font woosmap-travel-mode-option selected\"\n         data-travel-mode=\"DRIVING\">*\n    </div>\n    <div class=\"auchan-woosmap-travel-mode-choice auchan-woosmap-font woosmap-travel-mode-option\"\n         data-travel-mode=\"TRANSIT\">`\n    </div>\n    <div class=\"auchan-woosmap-travel-mode-choice auchan-woosmap-font woosmap-travel-mode-option\"\n         data-travel-mode=\"WALKING\">°\n    </div>\n</div>";
/* jshint ignore:end */
var AuchanSearch = function () {
    lateMixin(AuchanSearch.prototype, woosmap.utils.MVCObject.prototype);
    this.stores = null;
    this.location = null;
    this.query = null;
    this._isWaitingForStores = false;
    this.areStoresDefault = null;

    this.searchView = new woosmap.ui.SearchView(auchanTemplates.searchViewTemplate);

    var geocoder = new woosmap.location.GeocoderSearchSource({
        bounds: {
            west: -4.87293470,
            north: 51.089062,
            south: 42.19809198,
            east: 8.332631
        }
    });
    
    geocoder.location_changed = function(){
        var location = this.get('location');
        if(location){

            rRequestQueue.push(['sendUserSearchedPosition',[{
                lat: location.lat, 
                lng: location.lng                
            }]]);
        }
    };   
    
    var nearbyStoresSource = new woosmap.location.NearbyStoresSource(dataSource, 10, 60000);

    geocoder.bindTo('query', this.searchView, 'query', false);
    nearbyStoresSource.bindTo('location', geocoder, 'location');
    this.bindTo('location', geocoder, 'location', false);
    this.bindTo('stores', nearbyStoresSource);
    this.bindTo('query', this.searchView);

    this.container = this.searchView.getContainer();

    this.searchSummary = woosmap.$('<div id="id-auchan-woosmap-search-summary" class="auchan-woosmap-search-summary auchan-woosmap-info-panel">');
};

AuchanSearch.prototype.updateSearchSummary = function (query, numberOfStoresFind) {
    var html = 'Nous avons trouvé ' + numberOfStoresFind + ' magasin(s) à proximité de «' + query + '»';
    this.searchSummary.html(html);
    this.searchSummary.show();
};

AuchanSearch.prototype.hideSearchSummary = function () {
    this.searchSummary.hide();
};

AuchanSearch.prototype.showSearchSummary = function () {
    this.searchSummary.show();
};

AuchanSearch.prototype.query_changed = function () {
    var query = this.get('query');
    if (query) {
        this._isWaitingForStores = true;
        auchanEventListener.saveEvent('recherche', query);
    }    
};

AuchanSearch.prototype.stores_changed = function () {
    if (this._isWaitingForStores) {
        this.updateSearchSummary(this.get('query'), this.get('stores').length);
        this.set('areStoresDefault', false);
        this._isWaitingForStores = false;
    } else {
        this.hideSearchSummary();
        this.set('areStoresDefault', true);
    }
};

var AuchanPlaces = function () {
    lateMixin(AuchanPlaces.prototype, woosmap.utils.MVCObject.prototype);
    this.stores = null;
    this.location = null;
    this.query = null;
    this._isWaitingForStores = false;
    this.areStoresDefault = null;

    this.searchView = new woosmap.ui.SearchView({
        template: new woosmap.TemplateRenderer(auchanTemplates.searchViewTemplate).render({places: true})        
    });
    
    
    this.predictionsRenderer = new woosmap.TemplateRenderer(auchanTemplates.placesPredictionTemplate);    
    this.placesSearchSource = new woosmap.location.PlacesSearchSource({
        bounds: {
            west: -4.87293470,
            north: 51.089062,
            south: 42.19809198,
            east: 8.332631
        },
        types:['geocode']
    },3);
    
    var nearbyStoresSource = new woosmap.location.NearbyStoresSource(dataSource, 10, 60000);

    this.placesSearchSource.bindTo('autocomplete_query', this.searchView);
    var self = this;
    
    this.placesSearchSource.predictions_changed = function(){
        if(this.get('predictions')){
            self._isWaitingForStores = true;
            var predictions = {'predictions' : this.get('predictions')}; 
            woosmap.$('.auchan-woosmap-search-predictions')
                .css('display', 'block')
                .html(self.predictionsRenderer.render(predictions));
            
            woosmap.$('.pac-item').each(function(index, value){                
                woosmap.$(this).click(function(){                    
                    auchanEventListener.saveEvent('recherche',  predictions.predictions[index].description);
                });
            });
        }
        else{
            self._isWaitingForStores = false;
            woosmap.$('.auchan-woosmap-search-predictions').css('display', 'none');
        }
    };
    
    nearbyStoresSource.bindTo('location', this);
    this.bindTo('stores', nearbyStoresSource);
    this.bindTo('query', this.searchView);

    this.container = this.searchView.getContainer();
    this.setUpInteractions();
    this.searchSummary = woosmap.$('<div id="id-auchan-woosmap-search-summary" class="auchan-woosmap-search-summary auchan-woosmap-info-panel">');    
};


AuchanPlaces.prototype.setUpInteractions = function () {
    
    var self = this;
    
    var $thisContainer =  woosmap.$(this.container);
    
    
    $thisContainer.delegate('.pac-item', 'click', function(){
        var reference = woosmap.$(this).attr('data-reference');
        var query =  woosmap.$(this).text();
        
        self.placesSearchSource.getDetails(reference, function(result){
            self.set('location', {lat: result.location.lat, lng: result.location.lng,source: 'places'});
            woosmap.$('.auchan-woosmap-search-predictions').css('display', 'none');

            rRequestQueue.push(['sendUserSearchedPosition',[{
                lat: result.location.lat, 
                lng: result.location.lng                  
            }]]);
            self.set('query', query);
        }); 
    });

    $thisContainer.find('input').bind('keyup',function(e){
        switch(e.which) {
            //up
            case 38:
                if(woosmap.$('.pac-item-selected').length > 0){
                    woosmap.$('.pac-item-selected').prev().addClass('pac-item-selected');
                    woosmap.$('.pac-item-selected:last').removeClass('pac-item-selected');                    
                }
                else{
                    woosmap.$('.pac-item:last').addClass('pac-item-selected');
                 }
                break;
            //down
            case 40:
                if(woosmap.$('.pac-item-selected').length > 0){
                    woosmap.$('.pac-item-selected').next().addClass('pac-item-selected');
                    woosmap.$('.pac-item-selected:first').removeClass('pac-item-selected');
                }
                else{
                    woosmap.$('.pac-item:first').addClass('pac-item-selected');
                }
                break;
            //enter
            case 13:
                if(woosmap.$('.auchan-woosmap-search-predictions').css('display') === 'none'){
                    woosmap.$('.auchan-woosmap-search-predictions').show();  
                }
                else{
                    if(woosmap.$('.pac-item-selected').length > 0){
                        woosmap.$('.pac-item-selected').trigger('click');
                    }
                    else{
                        woosmap.$('.pac-item').first().trigger('click');
                    }
                }
                break;
        }
    });
};

AuchanPlaces.prototype.updateSearchSummary = function (query, numberOfStoresFind) {
    var html = 'Nous avons trouvé ' + numberOfStoresFind + ' magasin(s) à proximité de «' + query + '»';
    this.searchSummary.html(html);
    this.searchSummary.show();
};

AuchanPlaces.prototype.hideSearchSummary = function () {
    this.searchSummary.hide();
};

AuchanPlaces.prototype.showSearchSummary = function () {
    this.searchSummary.show();
};

AuchanPlaces.prototype.query_changed = function () {
    if (this.get('query')) {
        this._isWaitingForStores = true;
    }
};

AuchanPlaces.prototype.stores_changed = function () {
    if (this._isWaitingForStores) {
        this.updateSearchSummary(this.get('query'), this.get('stores').length);
        this.set('areStoresDefault', false);
        this._isWaitingForStores = false;
    } 
    else {
        this.hideSearchSummary();
        this.set('areStoresDefault', true);
    }
};

var AuchanSearchPanel = function (imagesBaseUrl, activeTab, onCellRenderingCallback, nearestStoreTabActivationCallback) {
    lateMixin(AuchanSearchPanel.prototype, woosmap.utils.MVCObject.prototype);
    this.container = woosmap.$('<div class="auchan-woosmap-search-panel">');
    this.stores = null;
    this.nearestStore = null;
    this.selectedStore = null;
    this.location = null;
    this.areStoresDefault = null;
    this.activeTab = null;
    this.zipCodeProvider = new woosmap.ZipCodeProvider();
    this.auchanDirectManager = new AuchanDirectManager();
    this.displayDirectPanel = null;

    this.zipCodeProvider.bindTo('location', this);
    this.auchanDirectManager.bindTo('zipcode', this.zipCodeProvider);
    this.bindTo('displayDirectPanel', this.auchanDirectManager);


    this._initNearestStoreView(imagesBaseUrl, activeTab);
    this._initSearchView(activeTab, onCellRenderingCallback);
    this.tabView = new AuchanTabView(this.tableView, activeTab);
    this.tabView.addToParent(this.container);
    this.bindTo('activeTab', this.tabView);
    this.nearestStoreTabActivationCallback = nearestStoreTabActivationCallback;
};

AuchanSearchPanel.prototype._initSearchView = function (activeTab, onCellRenderingCallback) {
    this.searchContainer = woosmap.$('<div id="auchan-woosmap-search-container">');
    if(activeTab === 'nearest'){ 
        this.searchContainer.hide();
    }
    // override the setupInteraction to avoid the keyup event to be added to the document
    woosmap.ui.TableView.prototype.setupInteraction  = function(){};

    this.tableView = new woosmap.ui.TableView({
        cell_store: auchanTemplates.defaultCellTemplate,
    });
    
    if(google && google.maps && google.maps.places){
        this.auchanSearchView = new AuchanPlaces();
    }
    else{
        this.auchanSearchView = new AuchanSearch();
    }    
    this.bindTo('location', this.auchanSearchView);

    var self = this;   
    
    this.tableView.setOnCellCreatedCallback(onCellRenderingCallback);

    this.auchanDirectContainer = woosmap.$(auchanTemplates.auchanDirectTemplate);

    this.auchanDirectContainer.find('.auchan-woosmap-direct-button').click(function(){
        auchanEventListener.saveEvent('resultats', 'lien_adirect');
    });
    this.auchanDirectContainer.hide();

    var tableViewContainer = woosmap.$('<div class="auchan-woosmap-table-view-container">');
    tableViewContainer.append(this.tableView.getContainer());
    this.searchContainer.append(this.auchanSearchView.container);
    this.searchContainer.append(this.auchanSearchView.searchSummary);
    this.searchContainer.append(tableViewContainer);
    this.searchContainer.append(this.auchanDirectContainer);

    this.container.append(this.searchContainer);

    tableViewContainer.hide();
    woosmap.$(this.tableView.getContainer()).hide();

    this.container.find('#id-auchan-woosmap-show-all-stores').click(function () {
        if (self.get('areStoresDefault')) {
            self._toggleStoresList();
        } else {
            self._clearResults();
        }
        auchanEventListener.saveEvent('tous_les_magasins', 'bloc_recherche');
    });
};

AuchanSearchPanel.prototype._toggleStoresList = function () {
    woosmap.$('.auchan-woosmap-table-view-container').toggle();
    woosmap.$(this.tableView.getContainer()).toggle();
};

AuchanSearchPanel.prototype._showStoresList = function () {
    woosmap.$('.auchan-woosmap-table-view-container').show();
    woosmap.$(this.tableView.getContainer()).show();
};

AuchanSearchPanel.prototype._hideStoresList = function () {
    woosmap.$('.auchan-woosmap-table-view-container').hide();
    woosmap.$(this.tableView.getContainer()).hide();
};

AuchanSearchPanel.prototype._clearResults = function () {
    this.auchanSearchView.searchView.clearResults();
    this.auchanDirectContainer.hide();
};

AuchanSearchPanel.prototype._initNearestStoreView = function (imagesBaseUrl, activeTab) {
    this.auchanNearestStoreView = new AuchanNearestStore(imagesBaseUrl);
    this.nearestStoreView = this.auchanNearestStoreView.container;
    if(activeTab === 'search'){
        this.nearestStoreView.hide();
    }
    this.container.append(this.nearestStoreView);

};

AuchanSearchPanel.prototype.addToSidebar = function (sidebar) {
    sidebar.bindTo('stores', this);
    sidebar.bindTo('areStoresDefault', this);
    sidebar.bindTo('nearestStore', this);

    this.bindTo('stores', this.auchanSearchView);
    this.bindTo('areStoresDefault', this.auchanSearchView);
    this.tableView.bindTo('stores', this);
    this.tableView.bindTo('selectedStore', this);
    this.bindTo('selectedStore', sidebar);
    
    this.bindTo('nearestStore', this.auchanNearestStoreView);
    sidebar.container.append(this.container);
};

AuchanSearchPanel.prototype.show = function () {
    this.container.show();
};

AuchanSearchPanel.prototype.hide = function () {
    this.container.hide();
};

AuchanSearchPanel.prototype.clearResults = function () {
    this.auchanSearchView.searchView.clearResults();
};

AuchanSearchPanel.prototype.areStoresDefault_changed = function () {
    var areStoresDefault = this.get('areStoresDefault');
    
    if (areStoresDefault) {
        this.tableView.setStoresTemplate(auchanTemplates.defaultCellTemplate);
        this.auchanDirectContainer.hide();
        this._hideStoresList();
    } 
    else {
        woosmap.$('.auchan-woosmap-table-view-container').show();
        woosmap.$(this.tableView.getContainer()).show();        
        this.tableView.setStoresTemplate(auchanTemplates.searchCellTemplate);
        if (this.get('displayDirectPanel')) {
           this.auchanDirectContainer.show();
        }
    }
};

AuchanSearchPanel.prototype.stores_changed = function () {
    var stores = this.get('stores');
    woosmap.$.each(stores, function (index, store) {
        store.properties.address.departementCode = store.properties.address.zipcode.slice(0, 2);
        store.properties.indexNumber = index + 1;
        store.properties.onlyDrive = store.properties.types.length === 1 &&
            store.properties.types.indexOf('drive') === 0;
    });
    if(!this.get('areStoresDefault')){
        this._showStoresList();
    }
    this.set('selectedStore', null);
};

AuchanSearchPanel.prototype.nearestStore_changed = function(){
    var nearestStore = this.get('nearestStore');
    nearestStore.properties.HTML5 = true;
    this.set('selectedStore', nearestStore);
};

AuchanSearchPanel.prototype.activeTab_changed = function(){
    var activeTab = this.get('activeTab');
    if (activeTab === this.tabView.NEAREST){
        var nearestStore = this.get('nearestStore');
        this.nearestStoreTabActivationCallback();
        if (nearestStore) {
            this.set('selectedStore', nearestStore);
        }
    }
    else{
        this.set('selectedStore', null);
    }
};

AuchanSearchPanel.prototype.location_changed = function () {
    var location = this.get('location');
    location.source = woosmap.location.LocationProvider.TYPE_HTML5;
    this.set('location', location);
};

AuchanSearchPanel.prototype.displayDirectPanel_changed = function () {
    if (this.get('displayDirectPanel')) {
        this.auchanDirectContainer.show();
    } else {
        this.auchanDirectContainer.hide();
    }
};
var AuchanDirectionsPanel = function (view, imagesBaseUrl) {
    lateMixin(AuchanDirectionsPanel.prototype, woosmap.utils.MVCObject.prototype);
    this.sidebar = null;
    this.container = woosmap.$('<div id="auchan-woosmap-directions-sidebar-panel">');
    this.selectedStore = null;
    this.view = view;
    this._initDirectionsView(view, imagesBaseUrl);

};

AuchanDirectionsPanel.prototype._initDirectionsView = function (view, imagesBaseUrl) {
    this.directionsDisplayer = new AuchanDirectionsDisplayer(view, imagesBaseUrl);
    this.container.append(this.directionsDisplayer.directionsContainer);
};

AuchanDirectionsPanel.prototype.addToSideBar = function (sidebar) {
    this.sidebar = sidebar;
    sidebar.container.append(this.container);
    this.bindTo('selectedStore', sidebar);
    var self = this;
    this.container.find('.auchan-woosmap-directions-close').click(function () {
        self.hide();
        sidebar.displaySearchView();
        woosmap.$('.auchan-woosmap-send-route-form').hide();
        woosmap.$('.auchan-woosmap-send-route-display-form').html('+');
    });
};

AuchanDirectionsPanel.prototype.show = function () {
    try {
        this.directionsDisplayer.bindTo('selectedStore', this);
    }
    catch (err) {
    }
    this.container.show();
};

AuchanDirectionsPanel.prototype.hide = function () {
    this.container.hide();
    try {
        this.directionsDisplayer.unbind('selectedStore', this);
        this.directionsDisplayer.set('route_visible', false);
        this.directionsDisplayer.cleanAll();
    }
    catch (err) {

    }

};


var AuchanSideBar = function (view, imagesBaseUrl, activeTab) {
    lateMixin(AuchanSideBar.prototype, woosmap.utils.MVCObject.prototype);
    this.stores = null;
    this.selectedStore = null;
    this.location = null;
    this.areStoresDefault = null;
    this.container = woosmap.$('<div class="auchan-woosmap-sidebar">');

    this.selectedStoreOnList = null;
    
    this.directionsPanel = new AuchanDirectionsPanel(view, imagesBaseUrl);
    this.directionsPanel.addToSideBar(this);

    this.selectedStore_changed = function(){
        var store = this.get('selectedStore');
        if(store && !store.properties.HTML5){
            var event = [];
            
            if(this.get('areStoresDefault')){
                event.push('tous_les_magasins');
            }
            else{
                event.push('resultats_recherche');
            }
            if(this.get('selectedStoreOnList')){
                event.push('liste');
                this.set('selectedStoreOnList', false);
            }
            else{
                event.push('carte');
            }
            event = event.join('/');
            var prop = store.properties;
            var str = [prop.name, prop.store_id, prop.address.zipcode];
            str = str.join('|');
            auchanEventListener.saveEvent(event,str);

            rRequestQueue.push(['sendUserConsultedPOI',[{
                lat: store.geometry.coordinates[1],
                lng: store.geometry.coordinates[0],
                id: prop.store_id
            }]]);
        }
    };
    
    var self = this;
    function onCellRenderingCallback ($cell) {
        
        $cell.find('.auchan-woosmap-cell-container').click(function(){
            self.set('selectedStoreOnList', true);
        });
        
        $cell.find('.auchan-woosmap-direction-link-icon').click(function () {
            self.displayDirectionsView();
        });
    }
    
    this.storesPanel = new AuchanSearchPanel(imagesBaseUrl, activeTab, onCellRenderingCallback, function() {
        self.storesPanel.auchanSearchView.searchView.clearResults();
        view.view.fitBounds(view.view.getDataBounds());
    });
    this.storesPanel.addToSidebar(this);
    this.displaySearchView();

    this.directionsPanel.directionsDisplayer.bindTo('query', this.storesPanel.auchanSearchView);
    this.isScreenMobile = false;
};

AuchanSideBar.prototype.DIRECTIONS = 'directions';
AuchanSideBar.prototype.SEARCH = 'search';


AuchanSideBar.prototype.showContainer = function (containerToShow) {
    if (containerToShow === this.DIRECTIONS) {
        this.storesPanel.hide();
        this.directionsPanel.show();
    } else if (containerToShow === this.SEARCH) {
        this.directionsPanel.hide();
        this.storesPanel.show();
    }
};

AuchanSideBar.prototype.displayDirectionsView = function (store_id) {
    this.showContainer(this.DIRECTIONS);
    var self = this;
    if (store_id) {
        dataSource.getStoreById(store_id, function (data) {
            data.properties.onlyDrive = data.properties.types.length === 1 &&
            data.properties.types.indexOf('drive') === 0;
            self.set('selectedStore', data);
        });
    }
    if (this.isScreenMobile){
        woosmap.$('html,body').animate({scrollTop: woosmap.$('body').offset().top});
    }
};

AuchanSideBar.prototype.displaySearchView = function() {
    this.showContainer(this.SEARCH);
};

var AuchanDirectionsDisplayer = function (view, imagesBaseUrl) {

    lateMixin(AuchanDirectionsDisplayer.prototype, woosmap.utils.MVCObject.prototype);

    this.directionsContainer = woosmap.$('<div>');
    this.selectedStore = null;
    this.originDestination = null;
    this.selectedTravelMode = null;
    this.mailView = null;
    this.auchanView = view;
    this.map = view.map;
    this.directionsMarkers = [];
    this.icons = {
        start: imagesBaseUrl + 'marker_start.png',
        end: imagesBaseUrl + 'marker.png'
    };
    this.route_visible = false;
    this.query = null;
    var self = this;
    this.location = null;
    this.html5Location = null;
    this.deviceDetector = new woosmap.DeviceDetector().getDeviceType();

    var newPolylineOption = {
        strokeColor: '#00B3FD',
        strokeOpacity: 1.0,
        strokeWeight: 4
    };

    var directionRendererOptions = {
        suppressMarkers: true,
        suppressInfoWindows: true,
        polylineOptions: newPolylineOption,
        preserveViewport: true
    };

    var googleDirectionsRequestOptions = {
        provideRouteAlternatives: true,
        durationInTraffic: true,
        region: 'fr'
    };

    this.navigatorGeolocation = new woosmap.location.LocationProvider();
    var travelModeSelector = new woosmap.ui.TravelModeSelector(auchanTemplates.travelModeTemplate);
    this.originDestinationInput = new woosmap.ui.OriginDestinationInput(auchanTemplates.originDestinationInputTemplate, {'geolocText': 'Ma Position'});
    var directionsProvider = new woosmap.location.DirectionsProvider(
        directionRendererOptions,
        googleDirectionsRequestOptions,
        this.displayErrorMessage.bind(this)
    );
    this.mailView = new woosmap.ui.MailView(auchanTemplates.mailViewTemplate);
    var mailOriginProvider = new woosmap.utils.MVCObject();
    mailOriginProvider.location = null;
    mailOriginProvider.originDestination_changed = function () {
        self.mailView.custom_params = {origin:this.get('originDestination').origin};
    };
    mailOriginProvider.bindTo('originDestination', this.originDestinationInput);

    this.directionsResultsDisplayer = new woosmap.ui.DirectionsResultsDisplayer(this.map, auchanTemplates.directionsSummaryTemplate,
        function () {
            //this function is called when directionResultsDisplayer finished to display renderers
            woosmap.$('.auchan-woosmap-route-travel-mode-icon').html(woosmap.$('.auchan-woosmap-travel-mode-choice.selected').html());
            self.showResultsContainers();
            self.directionsResultsDisplayer.displayRouteOnMap(0);
            self.directionsResultsDisplayer.displayRouteSteps(0);
            setTimeout(function () {
                self.updateStepsIcons();
            }, 5);
            woosmap.$(woosmap.$('.auchan-woosmap-route-container')[0]).addClass('selected');
            var computedDirections = self.directionsResultsDisplayer.get('directionsRenderers')[0].getDirections();
            var route = computedDirections.routes[0];
            var leg = route.legs[0];

            self.auchanView.view.fitBounds(route.bounds, {top: 70});

            self.cleanMarker();
            self.makeMarker(leg.start_location, self.icons.start, 'Start');

            if (self.deviceDetector === 'mobile') {
                woosmap.$('.auchan-desktop-button').hide();
            }

            woosmap.$('.auchan-woosmap-route-container').click(function () {
                var $this = woosmap.$(this);
                if ($this.hasClass('selected')) {
                    woosmap.$('.auchan-woosmap-route-steps-container').toggle();
                } else {
                    var rendererIndex = $this.data('renderer-index');
                    self.directionsResultsDisplayer.cleanMapFromRoutes();
                    self.directionsResultsDisplayer.cleanRouteSteps();
                    self.directionsResultsDisplayer.displayRouteOnMap(rendererIndex);
                    self.directionsResultsDisplayer.displayRouteSteps(rendererIndex);
                    var directions = self.directionsResultsDisplayer.get('directionsRenderers')[rendererIndex].getDirections();
                    var route = directions.routes[0];
                    self.auchanView.view.fitBounds(route.bounds, {top: 70});

                    woosmap.$('.auchan-woosmap-route-container').removeClass('selected');
                    $this.addClass('selected');

                    // 1ms is enough so we choose 5
                    setTimeout(function () {
                        self.updateStepsIcons();
                    }, 5);
                }
            });

            var store = self.get('selectedStore');
            if(store){
                var prop = store.properties;
                var str = [prop.name, prop.store_id, prop.address.zipcode];
                str = str.join('|');
                if(this.get('selectedStoreOnList')){
                    auchanEventListener.saveEvent('resultats_recherche/liste',str);
                    this.set('selectedStoreOnList', false);
                }
                auchanEventListener.saveEvent('itineraire', str);
            }
        }
    );

    this.originDestinationInput.bindTo('selectedStore', this);
    directionsProvider.bindTo('selectedTravelMode', travelModeSelector);
    directionsProvider.bindTo('originDestination', this.originDestinationInput);
    this.directionsResultsDisplayer.bindTo('directionsSummaries', directionsProvider);
    this.directionsResultsDisplayer.bindTo('directionsRenderers', directionsProvider);
    this.directionsResultsDisplayer.bindTo('directionsLink', directionsProvider);
    this.bindTo('location', this.navigatorGeolocation);
    this.originDestinationInput.bindTo('location', this, 'html5Location');
    this.mailView.bindTo('selectedStore', this);
    this.bindTo('originDestination', this.originDestinationInput);
    this.bindTo('selectedTravelMode', directionsProvider);

    function _update_mail_status(text, color) {
        var $mailStatusDiv = woosmap.$('.auchan-woosmap-mail-status');
        $mailStatusDiv.html(text).css('color', color);
        $mailStatusDiv.show();
        setTimeout(function () {
            $mailStatusDiv.hide(1000);
        }, 3000);
    }

    this.mailView.delegate = {
        mailSent: function () {
            _update_mail_status('Email envoyé', '#128c35');
            woosmap.$('.woosmap-mail-input').val('');
        },
        mailError: function () {
            _update_mail_status('Email erroné', '#de0b1e');
        },
        mailSending: function () {
            _update_mail_status('Envoi en cours', '#1badee');
        }
    };

    this.directionsContainer.append(travelModeSelector.getSelectorContainer());
    this.directionsContainer.append(this.originDestinationInput.getODContainer());
    this.errorContainer = woosmap.$('<div class="auchan-woosmap-directions-error auchan-woosmap-info-panel">');
    this.directionsContainer.append(this.errorContainer);
    this.directionsContainer.append(this.directionsResultsDisplayer.getRoutesContainer());
    var stepsContainer = woosmap.$('<div class="auchan-woosmap-route-steps-container">');
    var stepsDetails = woosmap.$('<div class="auchan-woosmap-route-steps-details">');
    stepsDetails.append(this.directionsResultsDisplayer.getStepsContainer());
    stepsContainer.append(auchanTemplates.routesStepsTitleTemplate);
    stepsContainer.append(stepsDetails);
    this.directionsContainer.append(stepsContainer);
    this.directionsContainer.append(this.mailView.getContainer());

    this.initHandler();
    this.restoreLocationForDirections();

};

AuchanDirectionsDisplayer.prototype.restoreLocationForDirections = function () {
    var current_url = new Url(window.location.href);
    var origin = current_url.getQueryValue('origin');
    if (origin) {
        this.originDestinationInput.setOriginValue(origin);
    }
};

AuchanDirectionsDisplayer.prototype.updateStepsIcons = function () {
    var markers = woosmap.$('.auchan-woosmap-route-steps-container').find('.adp-marker');
    woosmap.$(markers[0]).attr('src', this.icons.start);
    woosmap.$(markers[1]).attr('src', this.icons.end);
};

AuchanDirectionsDisplayer.prototype.isMobile = function () {
    return this.deviceDetector === 'mobile';
};

AuchanDirectionsDisplayer.prototype.initHandler = function () {
    var self = this;
    this.directionsContainer.find('.auchan-woosmap-geolocation-button').click(function () {
        self.hideResultsContainers();
        self.navigatorGeolocation.askForLocation(navigator.geolocation);
        auchanEventListener.saveEvent('itineraire', 'localisation');  
    });

    if (this.isMobile()) {
        this.directionsContainer.find('.auchan-woosmap-send-route-container').hide();
    } else {
        this.directionsContainer.find('.auchan-woosmap-send-route-header').click(function () {
            woosmap.$('.auchan-woosmap-send-route-form').toggle();
            if (woosmap.$('.auchan-woosmap-send-route-display-form').text() === '+') {
                woosmap.$('.auchan-woosmap-send-route-display-form').html('-');
            }
            else {
                woosmap.$('.auchan-woosmap-send-route-display-form').html('+');
            }
        });
    }

    this.directionsContainer.find('.woosmap-destination').on('input', function () {
        self.showOrHideSendForm();
    });

    this.directionsContainer.find('.woosmap-origin').on('input', function () {
        self.showOrHideSendForm();
    });

    this.directionsContainer.find('.auchan-woosmap-travel-mode-choice').click(function () {
        woosmap.$('.auchan-woosmap-travel-mode-choice').removeClass('selected');
        woosmap.$(this).addClass('selected');
    });       

    self.directionsContainer.find('.auchan-woosmap-send-route-button').click(function(){
        var store = self.get('selectedStore');
        if(store){
            var prop = store.properties;
            var str = [prop.name, prop.store_id, prop.address.zipcode];
            str = str.join('|');
            if(self.get('selectedStoreOnList')){
                auchanEventListener.saveEvent('resultats_recherche/liste',str);
                self.set('selectedStoreOnList', false);
            }
            auchanEventListener.saveEvent('itineraire_envoi_mobile', str);
        }    
    });
};

AuchanDirectionsDisplayer.prototype.showOrHideSendForm = function () {
    var isSelectedStoreNameInDestination = this.originDestinationInput.isSelectedStoreName(
        woosmap.$('.woosmap-destination').val()
    );
    var isSelectedStoreNameInOrigin = this.originDestinationInput.isSelectedStoreName(
        woosmap.$('.woosmap-origin').val()
    );

    if (!isSelectedStoreNameInDestination && !isSelectedStoreNameInOrigin || this.isMobile()) {
        woosmap.$('.auchan-woosmap-send-route-container').hide();
    } else {
        woosmap.$('.auchan-woosmap-send-route-container').show();
    }
};

AuchanDirectionsDisplayer.prototype.originDestination_changed = function () {
    this.showOrHideSendForm();
    this.cleanAll();
    this.hideResultsContainers();
};

AuchanDirectionsDisplayer.prototype.selectedTravelMode_changed = function () {
    this.cleanAll();
    this.hideResultsContainers();
};

AuchanDirectionsDisplayer.prototype.makeMarker = function (position, icon, title) {
    this.directionsMarkers.push(new google.maps.Marker({
        position: position,
        map: this.map,
        icon: icon,
        title: title,
        zIndex: google.maps.Marker.MAX_ZINDEX + 1
    }));
};

AuchanDirectionsDisplayer.prototype.cleanMarker = function () {
    woosmap.$.each(this.directionsMarkers, function (index, marker) {
        marker.setMap(null);
    });
    this.directionsMarkers = [];
};

AuchanDirectionsDisplayer.prototype.hideResultsContainers = function () {
    woosmap.$('.auchan-woosmap-route-container').hide();
    woosmap.$('.auchan-woosmap-route-steps-container').hide();
    this.errorContainer.hide();
};

AuchanDirectionsDisplayer.prototype.showResultsContainers = function () {
    woosmap.$('.auchan-woosmap-route-container').show();
    this.set('route_visible', true);
};

AuchanDirectionsDisplayer.prototype.cleanAll = function () {
    this.cleanMarker();
    this.directionsResultsDisplayer.cleanMapFromRoutes();
    this.directionsResultsDisplayer.cleanRouteSteps();
    this.directionsResultsDisplayer.cleanRoutes();
};

AuchanDirectionsDisplayer.prototype.displayErrorMessage = function (response, status) {
    if (status === google.maps.DirectionsStatus.ZERO_RESULTS || status === google.maps.DirectionsStatus.NOT_FOUND) {
        this.errorContainer.html('Nous n\'avons pas trouvé d\'itinéraire pour le mode de transport sélectionné.');
    } else {
        this.errorContainer.html('Une erreur est survenue pendant le calcul de l\'itinéraire, veuillez recommencer.');
    }
    this.errorContainer.show();
};

AuchanDirectionsDisplayer.prototype.location_changed = function () {
    var location = this.get('location');
    if (location.source === woosmap.location.LocationProvider.TYPE_HTML5) {
        this.set('html5Location', location);
        rRequestQueue.push(['sendUserHtml5Position',[{
            lat: location.lat, 
            lng: location.lng           
        }]]);  
    }
    else {
        this.errorContainer.html('Veuillez accepter la localisation dans votre navigateur pour utiliser votre position.');
        this.errorContainer.show();
    }
};

AuchanDirectionsDisplayer.prototype.query_changed = function () {
    this.originDestinationInput.getODContainer().find('.woosmap-origin').val(this.get('query'));
};
/**
 * Constructs a new Url
 * @constructor
 * @param {String}url which should be parsed
 */
var Url = function (url) {
    if (url === null) {
        url = '';
    }

    var parts = Url.pattern.exec(url);
    var partNames = [
        'url', 'scheme', 'ident', 'login', 'password', 'authority',
        'domain', 'port', 'path', '_query', 'fragment'];
    for (var i = 0; i < partNames.length; ++i){
        this[partNames[i]] = parts[i];
    }
    this._query = Url.parseQuery(this._query);
};

/**
 * Gets the query value of the key in the url
 * @param {String}key the query key
 */
Url.prototype.getQueryValue = function (key) {
    return this._query[key];
};

/*jshint ignore:start*/
Url.pattern = /(?:(?:([a-z]+):)?(?:\/\/(?:(([^:@]*)(?::([^@]*))?)@)?(([^:?#/]+)(?::(\d+))?)))?(?:((?:[^?#]*)?)(?:\?([^#]*))?(?:#(.*))?)$/;
/*jshint ignore:end*/

Url.parseQuery = function (queryStr) {
    var query = {};
    if (!queryStr) {
        return query;
    }

    var params = queryStr.split('&');
    for (var i = 0; i < params.length; i++) {
        var pair = params[i].split('=', 2);
        if (pair.length < 2) {
            pair[1] = '';
        }
        query[pair[0]] = decodeURIComponent(pair[1]);
    }
    return query;
};
var AuchanInfoWin = function (map, windowOpeningCallback, imagesBaseUrl) {
    lateMixin(AuchanInfoWin.prototype, woosmap.utils.MVCObject.prototype);

    this.selectedStore = null;
    this.imagesBaseUrl = imagesBaseUrl;
    this.windowOpeningCallback = windowOpeningCallback;

    this.infoWindowRenderer = new woosmap.TemplateRenderer(auchanTemplates.infoWindow);

    this.route_visible = false;


    this.infoBoxOptions = {
        disableAutoPan: false,
        pixelOffset: new google.maps.Size(22, -170),
        boxClass: 'auchan-woosmap-infobox-container',
        closeBoxMargin: '8px',
        closeBoxURL: this.imagesBaseUrl + 'close-infobox.png',
        infoBoxClearance: new google.maps.Size(1, 1)
    };
    this.initInfoWindows(map);
    this.isScreenMobile = null;
};

AuchanInfoWin.prototype.initInfoWindows = function (map) {
    
    this.infoWin = new woosmap.LocatorWindow(map, this.infoWindowRenderer, this.infoBoxOptions);
    this.infoWin.setOpeningCallback(this.windowOpeningCallback);

    this.mobileInfoWin = woosmap.$('<div id="auchan-woosmap-mobile-infowin" style="display: none"></div>');
    this.mobileInfoWin.insertBefore('.auchan-woosmap-map-container');  
};

AuchanInfoWin.prototype.updateMobileWindowWith = function (store) {
    var self = this;
    this.mobileInfoWin.empty();
    if (store) {
        this.mobileInfoWin.append(
            '<hr><div id="auchan-woosmap-mobile-close">' +
            '<img src="' + this.imagesBaseUrl + 'close-infobox.png">' +
            '</div>' +
            this.infoWindowRenderer.render(store.properties)
        );
        this.mobileInfoWin.find('#auchan-woosmap-mobile-close').click(function () {
            self.mobileInfoWin.hide();
            self.set('selectedStore', null);
        });

        this.windowOpeningCallback();
        if (!this.get('route_visible')) {
            this.mobileInfoWin.show();
        }
    } else {
        this.mobileInfoWin.hide();
    }
};

AuchanInfoWin.prototype.updateDesktopWindowWith = function (store) {
    if (this.get('route_visible') !== true) {
        this.infoWin.set('selectedStore', null);
        this.infoWin.set('selectedStore', store);
    }
};

AuchanInfoWin.prototype.selectedStore_changed = function () {
    var store = this.get('selectedStore');
    if (this.get('isScreenMobile') && !this.get('route_visible')) {
        this.updateMobileWindowWith(store);
        if (woosmap.$('#auchan-woosmap-mobile-close').offset()) {
            woosmap.$('html,body').animate({scrollTop: woosmap.$('#auchan-woosmap-mobile-close').offset().top});
        }
    } else if (store && store.properties) {
        var windowPosition = -170;
        if (store.properties.types.indexOf('drive') > -1 && store.properties.types.indexOf('auchan') > -1) {
            windowPosition = -300;
        }
        var offset = new google.maps.Size(22, windowPosition);
        this.infoWin.setInfoBoxOptions({pixelOffset: offset});
    }
};

AuchanInfoWin.prototype.route_visible_changed = function () {
    if (this.get('route_visible') === true) {
        if (this.get('isScreenMobile')) {
            woosmap.$('#auchan-woosmap-mobile-infowin').hide();
        } else {
            this.unbindSelectedStoreToInfowin();
            this.infoWin.close();
        }
    }
    else if (!this.get('isScreenMobile')) {
        this.bindSelectedStoreToInfowin();
        this.updateDesktopWindowWith(this.get('selectedStore'));
    }
    else if (this.get('isScreenMobile')) {
        this.set('selectedStore', null);
    }
};

AuchanInfoWin.prototype.isScreenMobile_changed = function () {
    if (this.get('isScreenMobile')) {
        var selectedStore = this.get('selectedStore');
        this.infoWin.close();
        this.unbindSelectedStoreToInfowin();
        this.set('selectedStore', selectedStore);
        this.updateMobileWindowWith(this.get('selectedStore'));
    }
    else {
        this.mobileInfoWin.hide();
        this.bindSelectedStoreToInfowin();
        this.updateDesktopWindowWith(this.get('selectedStore'));
    }
};


AuchanInfoWin.prototype.bindSelectedStoreToInfowin = function () {
    if (!this.infoWin.isPropertyBound('selectedStore')) {
        this.infoWin.bindTo('selectedStore', this);
    }
};

AuchanInfoWin.prototype.unbindSelectedStoreToInfowin = function () {
    if (this.infoWin.isPropertyBound('selectedStore')) {
        var store = this.get('selectedStore');
        this.infoWin.unbind('selectedStore');
        this.set('selectedStore', store);
    }
};

var AuchanNearestStore = function () {
    lateMixin(AuchanNearestStore.prototype, woosmap.utils.MVCObject.prototype);
    this.container = woosmap.$('<div class="auchan-woosmap-nearest-container">');
    this.renderer = new woosmap.TemplateRenderer(auchanTemplates.nearestStore);
    this.container.append(auchanTemplates.defaultNearestStore);
    this.location = null;
    this.html5Location = null;

    this.stores = null;
    this.nearestStore = null;

    var nearbySearchSource = new woosmap.location.NearbyStoresSource(dataSource, 1, 50000);
    var locationProvider = new woosmap.location.LocationProvider();

    this.bindTo('stores', nearbySearchSource);
    this.bindTo('location', locationProvider);
    nearbySearchSource.bindTo('location', this, 'html5Location');

    this.container.find('#auchan-woosmap-nearest-store-geolocation-button').click(function(){
        woosmap.$('.auchan-woosmap-nearest-store-explanation').html('<div id="loader"><div class="loader"></div>');
        locationProvider.askForLocation(navigator.geolocation);
        
        auchanEventListener.saveEvent('le_plus_proche', 'localisation');
    });
};

AuchanNearestStore.prototype.stores_changed = function () {
    var stores = this.get('stores');
    this.container.empty();
    if (stores && stores.length === 1) {
        this.set('nearestStore', stores[0]);
        this.container.append(this.renderer.render(stores[0].properties));

    }
 
    var self = this;
    self.container.find('.auchan-woosmap-link-button').click(function(){
        var store = self.get('nearestStore');
        if(store){
            var prop = store.properties;
            var str = [prop.name, prop.store_id, prop.address.zipcode];
            str = str.join('|');
            auchanEventListener.saveEvent('choix_magasin',str);            
        }
    });
};

AuchanNearestStore.prototype.location_changed = function () {
    var location = this.get('location');
    if (location.source === woosmap.location.LocationProvider.TYPE_HTML5) {
        this.set('html5Location', location);

        rRequestQueue.push(['sendUserHtml5Position',[{
            lat: location.lat, 
            lng: location.lng             
        }]]); 
    } else {
        woosmap.$('#auchan-woosmap-nearest-store-geolocation-button').addClass('disabled');
        woosmap.$('.auchan-woosmap-nearest-store-explanation').html('Veuillez accepter la localisation' +
                                                                    ' pour obtenir le magasin le plus proche de vous.');
        woosmap.$('#auchan-woosmap-nearest-store-geolocation-button').prop('onclick', null).off('click');
    }
};

var AuchanTabView = function (tableview, activeTab) {
    lateMixin(AuchanTabView.prototype, woosmap.utils.MVCObject.prototype);
    this.container = woosmap.$(new woosmap.TemplateRenderer(auchanTemplates.searchTitle).render({
        'search': activeTab === this.SEARCH, 
        'nearest': activeTab === this.NEAREST
    }));
    this.tableview = tableview;
    this.activeTab = null;
};

AuchanTabView.prototype.SEARCH = 'search';
AuchanTabView.prototype.NEAREST = 'nearest';

AuchanTabView.prototype.addToParent = function (parentContainer) {
    parentContainer.prepend(this.container);
    var tabs = parentContainer.find('.auchan-woosmap-tab');
    var self = this;

    tabs.on('click', function() {
        var $this = woosmap.$(this);
        var $target = woosmap.$($this.attr('rel'));

        var targets = woosmap.$.map(tabs, function(val, i) {
            return woosmap.$(val).attr('rel');
        });

        woosmap.$.each(targets, function(k, v) {
            woosmap.$(v).hide();
        });

        tabs.removeClass('auchan-woosmap-tab-selected');
        $this.addClass('auchan-woosmap-tab-selected');
        $target.show();
        if ($target.selector === '.auchan-woosmap-nearest-container'){
            self.set('activeTab', self.NEAREST);
            auchanEventListener.saveEvent('onglet_recherche', 'le_plus_proche');
        }
        else {
            self.set('activeTab', self.SEARCH);
            auchanEventListener.saveEvent('onglet_recherche', 'rechercher_magasin');
        }
    });
};

var AuchanView = function (map, markersIcons) {
    lateMixin(AuchanView.prototype, woosmap.utils.MVCObject.prototype);

    this.view = new woosmap.View(map, markersIcons, 11);
    this.view.set('padding', {left: 350});
    this.view.marker.setOptions({visible: false});
    this.route_visible = null;
    this.selectedStore = null;
    this.location = null;
    this.stores = null;

    this.isScreenMobile = null;
    this.isMapMinimized = false;
    this.map = map;

    this.view.bindTo('selectedStore', this);
    this.view.bindTo('location', this);
    this.view.bindTo('stores', this);
    
    var self = this;
    woosmap.$('.auchan-woosmap-map-hidder').click(function () {
        self._toggleMinimization();
    }).hide();

    this.TOGGLE_SIZE_BUTTON_ACTIVATE_TEXT = 'Activer';
    this.TOGGLE_SIZE_BUTTON_DEACTIVATE_TEXT = 'Désactiver';

    this.toggleSizeButton = woosmap.$('<div class="auchan-woosmap-toggle-size-map" id="auchan-woosmap-toggle-size-button">');
    this.toggleSizeButton.html(this.TOGGLE_SIZE_BUTTON_DEACTIVATE_TEXT).hide();

    google.maps.event.addDomListener(this.toggleSizeButton[0], 'click', function () {
        self._toggleMinimization();
    });

    map.controls[google.maps.ControlPosition.TOP_LEFT].push(this.toggleSizeButton[0]);

};

AuchanView.prototype.route_visible_changed = function () {
    var routeIsNotVisible = this.get('route_visible') !== true;
    this.view.enableZoom(routeIsNotVisible);
    this.view.enablePan(routeIsNotVisible);
};


AuchanView.prototype._toggleMinimization = function () {
    var isMapMinimized = this.get('isMapMinimized');
    var isScreenMobile = this.get('isScreenMobile');
    var shouldMaximize = isMapMinimized || !isScreenMobile;
    var text = shouldMaximize ? this.TOGGLE_SIZE_BUTTON_DEACTIVATE_TEXT : this.TOGGLE_SIZE_BUTTON_ACTIVATE_TEXT;
    var selectedStore = this.view.get('selectedStore');
    var selector = isScreenMobile ? this.toggleSizeButton : woosmap.$('#woosmap-store-locator');

    google.maps.event.trigger(this.map, 'resize');

    if (selectedStore === null) {
        this.view.fitBounds(this.view.getDataBounds());
    }

    woosmap.$('.auchan-woosmap-map-hidder').toggle(!shouldMaximize);
    this.toggleSizeButton.html(text);
    this.toggleSizeButton.toggle(isScreenMobile);
    this.map.setOptions({
        scrollwheel: shouldMaximize,
        draggable: shouldMaximize,
        streetViewControl: shouldMaximize,
        mapTypeControl: shouldMaximize,
        zoomControl: shouldMaximize
    });
    woosmap.$('html,body').animate({scrollTop: selector.offset().top});
    this.set('isMapMinimized', !shouldMaximize);
};

AuchanView.prototype.isScreenMobile_changed = function () {
    this._toggleMinimization();
    if (this.get('isScreenMobile')) {
        this.view.set('padding', null);
    } else {
        this.view.set('padding', {left: 350});
    }
    if (this.view.get('stores') && this.view.get('stores').length > 0) {
        var selectedStore = this.view.get('selectedStore');
        if (selectedStore) {
            var coordinates = selectedStore.geometry.coordinates;
            this.map.panTo(new google.maps.LatLng(coordinates[1], coordinates[0]));
        }
        else {
            this.view.fitBounds(this.view.getDataBounds());
        }
    }
};
var AuchanScreenManager = function (map) {
    lateMixin(AuchanScreenManager.prototype, woosmap.utils.MVCObject.prototype);

    this.isScreenMobile = null;

    var self = this;
    woosmap.$(window).resize(function() {
        self.checkIfScreenIsMobile();
        google.maps.event.trigger(map, 'resize');
    });

};

AuchanScreenManager.prototype.checkIfScreenIsMobile = function () {
    this.set('isScreenMobile', window.matchMedia && window.matchMedia('(max-width: 736px)').matches);
};
var AuchanEventManager = function () {};

AuchanEventManager.prototype.saveEvent = function (eventLabel, eventValue) {
    /*jshint ignore:start*/
    if (typeof trackTagCommander === "function") {
        trackTagCommander('store_locator',eventLabel, eventValue);
    }
    /*jshint ignore:end*/
};
var dataSource = null;
var auchanEventListener = new AuchanEventManager();

var rRequestQueue = [];

(function () {

    var AuchanLocator = function (config) {
        config = config || {};
        this.selector = config.selector;
        this.key = config.key;
        this.googleKey = config.googleKey;
        this.channelId = config.channelId || 'auchan-france';
        this.activeTab = config.activeTab || 'search';
        this.places = config.places || false;
        this.imagesBaseUrl = config.imagesBaseUrl;
        this.defaultStores = null;
        var version = config.sdkVersion || '1.1';

        rRequestQueue.push(['setProjectKey', [config.key]]);
        
        if(this.activeTab !== 'search' && this.activeTab !== 'nearest'){
            this.activeTab = 'search';
        }
        
        if (!this.selector) {
            throw 'Selector for locator is not defined.';
        }

        if (!this.key) {
            throw 'Key is not defined';
        }

        if (!this.googleKey || this.googleKey === '') {
            throw 'GoogleKey is not defined';
        }
        this._loadWoosmapRecommendation();
        this._loadWoosmap(version);
    };

    AuchanLocator.prototype.init = function () {        
        
        var options = {
            clientId: this.googleKey,
            channelId: this.channelId
        }; 
        if (this.places){
            options.librariesToLoad = ['places'];
        }
        var mapsLoader = new woosmap.MapsLoader(options);
        dataSource = new woosmap.DataSource();

        mapsLoader.load(function () {

            this.initMap();
        }.bind(this));

    };

    AuchanLocator.prototype.initMap = function () {
        var self = this;
        this.container = woosmap.$(this.selector);
        var mapContainer = woosmap.$('<div class="auchan-woosmap-map-container">');
        mapContainer.append(
            woosmap.$('<div class="woosmap-map">'));
        mapContainer.append(woosmap.$('<div class="auchan-woosmap-map-hidder">'));
        this.container.append(mapContainer);
        
        var map = new google.maps.Map(this.container.find('.woosmap-map')[0], {
            center: {lat: 47, lng: 2},
            zoom: 6,
            disableDefaultUI: true,
            zoomControl: true,
            zoomControlOptions: {
                style: google.maps.ZoomControlStyle.SMALL,
                position: google.maps.ControlPosition.RIGHT_BOTTOM
            },
            mapTypeControl: true,
            mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.DEFAULT,
                mapTypeIds: [
                    google.maps.MapTypeId.ROADMAP,
                    google.maps.MapTypeId.SATELLITE
                ],
                position: google.maps.ControlPosition.TOP_RIGHT
            },
            streetView: new google.maps.StreetViewPanorama(woosmap.$('.woosmap-map')[0],{
                disableDefaultUI: true,
                visible: false
            }),
            streetViewControl: true,
            streetViewControlOptions: {
                position: google.maps.ControlPosition.RIGHT_BOTTOM
            },
            styles: [
                {
                    featureType: 'poi',
                    elementType: 'labels',
                    stylers: [
                        {
                            visibility: 'off'
                        }
                    ]
                }
            ]
        });

        this.map = map;

        var markersIcons = [{
            type: 'default',
            'default': this.imagesBaseUrl,
            selected: this.imagesBaseUrl + 'selected-marker.png'
        }];
        this.auchanView = new AuchanView(map, markersIcons);

        this.sidebar = new AuchanSideBar(this.auchanView, this.imagesBaseUrl, this.activeTab);
        this.sidebar.bindTo('selectedStore', this.auchanView, 'selectedStore', false);
        this.auchanView.bindTo('location', this.sidebar, 'location', false);
        this.auchanView.bindTo('stores', this.sidebar);
        
        this.container.prepend(this.sidebar.container);

        // streetivew custom control
        woosmap.$('.woosmap-map').append(woosmap.$('<div class="woosmap-streetView">')
            .append(
                woosmap.$('<div class="woosmap-streetView-close">')
            )
            .hide()
        );        
        
        var panorama = map.getStreetView();
        google.maps.event.addListener(panorama, 'visible_changed', function () {
            if (panorama.getVisible()) {
                woosmap.$('.auchan-woosmap-sidebar').css('z-index', -1);
                woosmap.$('.woosmap-streetView').show();
            }
            else {
                woosmap.$('.auchan-woosmap-sidebar').css('z-index', 1);
                woosmap.$('.woosmap-streetView').hide();
            }
        });        
        woosmap.$('.woosmap-streetView').click(function(){
            panorama.setVisible(false);
        });

        
        
        this.sidebar.storesPanel.auchanSearchView.searchView.delegate = {
            didClearSearch: function () {
                self.auchanView.set('selectedStore', null);
                self.displayAllStores();
            }
        };

        function displayDirectionOnClickListener() {
            woosmap.$('.auchan-woosmap-open-directions').click(function () {
                self.sidebar.displayDirectionsView();
            });

            woosmap.$('.auchan-woosmap-show-store-button').click(function(){
                var store = self.auchanView.get('selectedStore');
                if(store){
                    var prop = store.properties;
                    var str = [prop.name, prop.store_id, prop.address.zipcode];
                    str = str.join('|');
                    auchanEventListener.saveEvent('voir_magasin', str);                    
                }
            });
            
            woosmap.$('.auchan-woosmap-show-drive-store-button').click(function(){
                var store = self.auchanView.get('selectedStore');
                if(store){
                    var prop = store.properties;
                    var str = [prop.name, prop.store_id, prop.address.zipcode];
                    str = str.join('|');
                    auchanEventListener.saveEvent('auchan_drive', str);                    
                }
            });
        }

        this.auchanInfoWin = new AuchanInfoWin(map, displayDirectionOnClickListener, this.imagesBaseUrl);
        this.auchanInfoWin.bindTo('selectedStore', this.auchanView.view);
        this.auchanInfoWin.bindTo('route_visible', this.sidebar.directionsPanel.directionsDisplayer);
        this.auchanView.bindTo('route_visible', this.sidebar.directionsPanel.directionsDisplayer);

        this.screenManager = new AuchanScreenManager(this.map);
        this.auchanInfoWin.bindTo('isScreenMobile', this.screenManager);
        this.auchanView.bindTo('isScreenMobile', this.screenManager);
        this.sidebar.bindTo('isScreenMobile', this.screenManager);
        this.screenManager.checkIfScreenIsMobile();

        this.displayAllStores();
    };

    AuchanLocator.prototype.displayAllStores = function () {
        var self = this;
        if (!this.defaultStores) {
            dataSource.getAllStores(function (stores) {
                var sortedStores = this.sortStores(stores.features);
                this.sidebar.set('stores', sortedStores);
                this.defaultStores = sortedStores;
                setTimeout(function () {
                    self.restoreDirectionsIfNeeded();
                }, 500);
            }.bind(this));
        } 
        else {
            this.sidebar.set('stores', this.defaultStores);
            this.sidebar.set('areStoresDefault', true);
        }
    };

    AuchanLocator.prototype._loadWoosmapRecommendation = function (version) {
        var recoScript = document.createElement('script');
        recoScript.async = true;
        recoScript.src = '//recommendation-js.woosmap.com/recommendation.js';
        document.documentElement.firstChild.appendChild(recoScript);
    };
    
    AuchanLocator.prototype._loadWoosmap = function (version) {
        if (window.attachEvent) {
            var self = this;
            window.attachEvent('onload', function () {
                WoosmapLoader.load(version, self.key, self.init, self);
            });
        }
        else {
            window.addEventListener('load', WoosmapLoader.load(version, this.key, this.init, this), false);
        }
    };

    AuchanLocator.prototype.sortStores = function (stores) {

        function compareFunction(storeA, storeB) {
            var zipCodeA = parseFloat(storeA.properties.address.zipcode);
            var zipCodeB = parseFloat(storeB.properties.address.zipcode);
            if (isNaN(zipCodeA)) {
                return 1;
            } else if (isNaN(zipCodeB)) {
                return -1;
            }
            return zipCodeA - zipCodeB;
        }

        return stores.sort(compareFunction);
    };

    AuchanLocator.prototype.restoreDirectionsIfNeeded = function () {
        var current_url = new Url(window.location.href);
        var store_id = current_url.getQueryValue('store_id');
        if (store_id) {
            this.sidebar.displayDirectionsView(store_id);
        }
    };

    window.AuchanLocator = AuchanLocator;
})();
